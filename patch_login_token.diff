const errorMessage = data && typeof data === 'object' && data.message ? data.message : 'Error al iniciar sesión. Inténtalo de nuevo.';
        throw new Error(errorMessage);
      }

      if (!data || !data.usuario) {
        const userObject = data;
        if (userObject && (userObject.id || userObject._id || userObject.email)) {
          localStorage.setItem('usuario', JSON.stringify(userObject));
        } else {
          throw new Error('La respuesta del servidor no contiene la información esperada (usuario o un objeto de usuario directamente).');
        }
      } else {
        localStorage.setItem('usuario', JSON.stringify(data.usuario));
      }
=======
      if (!res.ok) {
        const errorMessage = data && typeof data === 'object' && data.message ? data.message : 'Error al iniciar sesión. Inténtalo de nuevo.';
        throw new Error(errorMessage);
      }

      // Store token if present in response data
      if (data.token) {
        localStorage.setItem('token', data.token);
      }

      if (!data || !data.usuario) {
        const userObject = data;
        if (userObject && (userObject.id || userObject._id || userObject.email)) {
          localStorage.setItem('usuario', JSON.stringify(userObject));
        } else {
          throw new Error('La respuesta del servidor no contiene la información esperada (usuario o un objeto de usuario directamente).');
        }
      } else {
        localStorage.setItem('usuario', JSON.stringify(data.usuario));
      }
